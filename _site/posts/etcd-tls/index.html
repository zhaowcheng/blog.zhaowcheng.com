<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="pv-cache-path" content="/pageviews.json"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="ETCD 配置 TLS" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="前提知识： SSL/TLS 笔记" /><meta property="og:description" content="前提知识： SSL/TLS 笔记" /><link rel="canonical" href="https://zhaowcheng.com/posts/etcd-tls/" /><meta property="og:url" content="https://zhaowcheng.com/posts/etcd-tls/" /><meta property="og:site_name" content="zhaowcheng" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-01-25T19:43:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="ETCD 配置 TLS" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhaowcheng.com/posts/etcd-tls/"},"url":"https://zhaowcheng.com/posts/etcd-tls/","description":"前提知识： SSL/TLS 笔记","dateModified":"2025-01-26T19:45:38+08:00","datePublished":"2025-01-25T19:43:00+08:00","headline":"ETCD 配置 TLS","@type":"BlogPosting","@context":"https://schema.org"}</script><title>ETCD 配置 TLS | zhaowcheng</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zhaowcheng"><meta name="application-name" content="zhaowcheng"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/android-chrome-512x512.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">zhaowcheng</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/zhaowcheng" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['zhaowcheng','163.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>ETCD 配置 TLS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>ETCD 配置 TLS</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> zhaowcheng </span> 发表于 <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="2025-01-25, 19:43 +0800" >01-25<i class="unloaded">2025-01-25T19:43:00+08:00</i> </span></div><div> <span> 更新于 <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="2025-01-26, 19:45 +0800" >01-26<i class="unloaded">2025-01-26T19:45:38+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3123 字">17 分钟 阅读</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> 次浏览</div></div><div class="post-content"><p>前提知识： <a href="https://blog.zhaowcheng.com/posts/ssl-notes/">SSL/TLS 笔记</a></p><p>本文章演示如何在已有 ETCD 集群上同时配置开启 <code class="language-plaintext highlighter-rouge">客户端与服务端之间（client-to-server）</code> 和 <code class="language-plaintext highlighter-rouge">服务端与服务端之间（server-to-server/peer）</code> 的 TLS。</p><p><strong>建议在操作前先备份 data 目录和配置文件！</strong></p><p>已有集群信息如下：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>etcdctl member list <span class="nt">-w</span> table
<span class="go">+------------------+---------+-------+---------------------------+---------------------------+------------+
|        ID        | STATUS  | NAME  |        PEER ADDRS         |       CLIENT ADDRS        | IS LEARNER |
+------------------+---------+-------+---------------------------+---------------------------+------------+
| e36d8869dc221ffe | started | node1 | http://192.168.10.11:2380 | http://192.168.10.11:2379 |      false |
| 243fcfa74ec0736a | started | node2 | http://192.168.10.12:2380 | http://192.168.10.12:2379 |      false |
| c8ad351a3ef67e9e | started | node3 | http://192.168.10.13:2380 | http://192.168.10.13:2379 |      false |
+------------------+---------+-------+---------------------------+---------------------------+------------+
</span></pre></table></code></div></div><h2 id="生成证书">生成证书</h2><h3 id="使用-python-生成">使用 python 生成</h3><p>下面示例中使用的 python 脚本 <code class="language-plaintext highlighter-rouge">gen_etcd_certs.py</code> 源码在文章末尾附上。</p><p>生成 <code class="language-plaintext highlighter-rouge">根证书和私钥</code>：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>python gen_etcd_certs.py <span class="nt">-c</span> gen_root_cert <span class="nt">-s</span> ./certs 
<span class="go">Saved: ./certs/root.key
Saved: ./certs/root.cert
</span></pre></table></code></div></div><p>生成 <code class="language-plaintext highlighter-rouge">客户端证书和私钥</code>：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>python gen_etcd_certs.py <span class="nt">-c</span> gen_client_cert <span class="nt">-s</span> ./certs <span class="nt">-k</span> certs/root.key <span class="nt">-t</span> certs/root.cert
<span class="go">Saved: ./certs/client.key
Saved: ./certs/client.cert
</span></pre></table></code></div></div><p>生成 <code class="language-plaintext highlighter-rouge">节点证书和私钥</code>：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>python gen_etcd_certs.py <span class="nt">-c</span> gen_server_cert <span class="nt">-s</span> ./certs <span class="nt">-k</span> certs/root.key <span class="nt">-t</span> certs/root.cert <span class="nt">-i</span> 192.168.10.11
<span class="go">Saved: ./certs/192.168.10.11.key
Saved: ./certs/192.168.10.11.cert

</span><span class="gp">$</span><span class="w"> </span>python gen_etcd_certs.py <span class="nt">-c</span> gen_server_cert <span class="nt">-s</span> ./certs <span class="nt">-k</span> certs/root.key <span class="nt">-t</span> certs/root.cert <span class="nt">-i</span> 192.168.10.12
<span class="go">Saved: ./certs/192.168.10.12.key
Saved: ./certs/192.168.10.12.cert

</span><span class="gp">$</span><span class="w"> </span>python gen_etcd_certs.py <span class="nt">-c</span> gen_server_cert <span class="nt">-s</span> ./certs <span class="nt">-k</span> certs/root.key <span class="nt">-t</span> certs/root.cert <span class="nt">-i</span> 192.168.10.13
<span class="go">Saved: ./certs/192.168.10.13.key
Saved: ./certs/192.168.10.13.cert
</span></pre></table></code></div></div><h3 id="使用-openssl-生成">使用 openssl 生成</h3><p>生成 <code class="language-plaintext highlighter-rouge">根证书和私钥</code>：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>openssl genrsa <span class="nt">-out</span> root.key 2048
<span class="go">Generating RSA private key, 2048 bit long modulus
.............................+++
........................................+++
e is 65537 (0x10001)

</span><span class="gp">$</span><span class="w"> </span>openssl req <span class="nt">-new</span> <span class="nt">-sha256</span> <span class="nt">-key</span> root.key <span class="nt">-out</span> root.csr <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC/CN=CA"</span>
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 3650 <span class="nt">-sha256</span> <span class="nt">-signkey</span> root.key <span class="nt">-in</span> root.csr <span class="nt">-out</span> root.cert
<span class="go">Signature ok
subject=/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC/CN=CA
Getting Private key
</span></pre></table></code></div></div><p>生成 <code class="language-plaintext highlighter-rouge">客户端证书和私钥</code>：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>openssl genrsa <span class="nt">-out</span> client.key 2048
<span class="go">Generating RSA private key, 2048 bit long modulus
.........+++
......+++
e is 65537 (0x10001)

</span><span class="gp">$</span><span class="w"> </span>openssl req <span class="nt">-new</span> <span class="nt">-sha256</span> <span class="nt">-key</span> client.key  <span class="nt">-out</span> client.csr <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC"</span>
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 3650 <span class="nt">-sha256</span> <span class="nt">-CA</span>  root.cert <span class="nt">-CAkey</span> root.key  <span class="nt">-CAserial</span> root.srl  <span class="nt">-CAcreateserial</span> <span class="nt">-in</span> client.csr <span class="nt">-out</span> client.cert
<span class="go">Signature ok
subject=/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC
Getting CA Private Key
</span></pre></table></code></div></div><p>生成 <code class="language-plaintext highlighter-rouge">节点证书和私钥</code>：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>openssl genrsa <span class="nt">-out</span> 192.168.10.11.key 2048
<span class="go">Generating RSA private key, 2048 bit long modulus
.......................+++
..................................+++
e is 65537 (0x10001)
</span><span class="gp">$</span><span class="w"> </span>openssl req <span class="nt">-new</span> <span class="nt">-sha256</span> <span class="nt">-key</span> 192.168.10.11.key <span class="nt">-out</span> 192.168.10.11.csr <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC"</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"subjectAltName = @names</span><span class="se">\n</span><span class="s2">[names]</span><span class="se">\n</span><span class="s2">IP.1 = 127.0.0.1</span><span class="se">\n</span><span class="s2">IP.2 = 192.168.10.11"</span> <span class="o">&gt;</span> 192.168.10.11.ext
<span class="gp">$</span><span class="w"> </span>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 3650 <span class="nt">-sha256</span> <span class="nt">-CA</span>  root.cert <span class="nt">-CAkey</span> root.key  <span class="nt">-CAserial</span> root.srl  <span class="nt">-CAcreateserial</span> <span class="nt">-in</span> 192.168.10.11.csr <span class="nt">-out</span> 192.168.10.11.cert <span class="nt">-extfile</span> 192.168.10.11.ext
<span class="go">Signature ok
subject=/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC
Getting CA Private Key

</span><span class="gp">$</span><span class="w"> </span>openssl genrsa <span class="nt">-out</span> 192.168.10.12.key 2048
<span class="go">Generating RSA private key, 2048 bit long modulus
.......................+++
..................................+++
e is 65537 (0x10001)
</span><span class="gp">$</span><span class="w"> </span>openssl req <span class="nt">-new</span> <span class="nt">-sha256</span> <span class="nt">-key</span> 192.168.10.12.key <span class="nt">-out</span> 192.168.10.12.csr <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC"</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"subjectAltName = @names</span><span class="se">\n</span><span class="s2">[names]</span><span class="se">\n</span><span class="s2">IP.1 = 127.0.0.1</span><span class="se">\n</span><span class="s2">IP.2 = 192.168.10.12"</span> <span class="o">&gt;</span> 192.168.10.12.ext
<span class="gp">$</span><span class="w"> </span>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 3650 <span class="nt">-sha256</span> <span class="nt">-CA</span>  root.cert <span class="nt">-CAkey</span> root.key  <span class="nt">-CAserial</span> root.srl  <span class="nt">-CAcreateserial</span> <span class="nt">-in</span> 192.168.10.12.csr <span class="nt">-out</span> 192.168.10.12.cert <span class="nt">-extfile</span> 192.168.10.12.ext
<span class="go">Signature ok
subject=/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC
Getting CA Private Key

</span><span class="gp">$</span><span class="w"> </span>openssl genrsa <span class="nt">-out</span> 192.168.10.13.key 2048
<span class="go">Generating RSA private key, 2048 bit long modulus
.......................+++
..................................+++
e is 65537 (0x10001)
</span><span class="gp">$</span><span class="w"> </span>openssl req <span class="nt">-new</span> <span class="nt">-sha256</span> <span class="nt">-key</span> 192.168.10.13.key <span class="nt">-out</span> 192.168.10.13.csr <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC"</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"subjectAltName = @names</span><span class="se">\n</span><span class="s2">[names]</span><span class="se">\n</span><span class="s2">IP.1 = 127.0.0.1</span><span class="se">\n</span><span class="s2">IP.2 = 192.168.10.13"</span> <span class="o">&gt;</span> 192.168.10.13.ext
<span class="gp">$</span><span class="w"> </span>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 3650 <span class="nt">-sha256</span> <span class="nt">-CA</span>  root.cert <span class="nt">-CAkey</span> root.key  <span class="nt">-CAserial</span> root.srl  <span class="nt">-CAcreateserial</span> <span class="nt">-in</span> 192.168.10.13.csr <span class="nt">-out</span> 192.168.10.13.cert <span class="nt">-extfile</span> 192.168.10.13.ext
<span class="go">Signature ok
subject=/C=CN/ST=CQ/L=YB/O=BC/OU=ZWC
Getting CA Private Key
</span></pre></table></code></div></div><h2 id="上传证书">上传证书</h2><div class="table-wrapper"><table><thead><tr><th>节点<th>需要上传的文件<tbody><tr><td>192.168.10.11<td><code class="language-plaintext highlighter-rouge">root.cert</code>, <code class="language-plaintext highlighter-rouge">root.key</code>, <code class="language-plaintext highlighter-rouge">client.cert</code>, <code class="language-plaintext highlighter-rouge">client.key</code>, <code class="language-plaintext highlighter-rouge">192.168.10.11.cert</code>, <code class="language-plaintext highlighter-rouge">192.168.10.11.key</code><tr><td>192.168.10.12<td><code class="language-plaintext highlighter-rouge">root.cert</code>, <code class="language-plaintext highlighter-rouge">root.key</code>, <code class="language-plaintext highlighter-rouge">client.cert</code>, <code class="language-plaintext highlighter-rouge">client.key</code>, <code class="language-plaintext highlighter-rouge">192.168.10.12.cert</code>, <code class="language-plaintext highlighter-rouge">192.168.10.12.key</code><tr><td>192.168.10.13<td><code class="language-plaintext highlighter-rouge">root.cert</code>, <code class="language-plaintext highlighter-rouge">root.key</code>, <code class="language-plaintext highlighter-rouge">client.cert</code>, <code class="language-plaintext highlighter-rouge">client.key</code>, <code class="language-plaintext highlighter-rouge">192.168.10.13.cert</code>, <code class="language-plaintext highlighter-rouge">192.168.10.13.key</code></table></div><h2 id="更新配置">更新配置</h2><p>节点 <code class="language-plaintext highlighter-rouge">192.168.10.11</code> 配置文件需要更新的配置：</p><pre><code class="language-YAML">listen-peer-urls: https://0.0.0.0:2380
listen-client-urls: https://0.0.0.0:2379
advertise-client-urls: https://192.168.10.11:2379
client-transport-security:
  # 服务端证书，在 TLS 握手过程中提供给客户端。
  cert-file: /path/to/192.168.10.11.cert
  # 服务端私钥，用来解密客户端使用服务端公钥加密发送的数据。
  key-file: /path/to/192.168.10.11.key
  # 是否要求客户端访问时提供客户端证书。
  client-cert-auth: true
  # 受信任的 CA 证书（root 证书/根证书），用来验证客户端证书。
  trusted-ca-file: /path/to/root.cert
  # 是否自动配置 TLS，开启该配置后则无需上面的其他配置。
  auto-tls: false
peer-transport-security:
  # 本节点证书，在 TLS 握手过程中提供给伙伴节点。
  cert-file: /path/to/192.168.10.11.cert
  # 本节点私钥，用来解密伙伴节点使用本节点公钥加密发送的数据。
  key-file: /path/to/192.168.10.11.key
  # 是否要求伙伴节点访问时提供其证书。
  client-cert-auth: true
  # 受信任的 CA 证书（root 证书/根证书），用来验证伙伴节点证书。
  trusted-ca-file: /path/to/root.cert
  # 是否自动配置 TLS，开启该配置后则无需上面的其他配置。
  auto-tls: false
</code></pre><p>节点 <code class="language-plaintext highlighter-rouge">192.168.10.12</code> 配置文件需要更新的配置：</p><pre><code class="language-YAML">listen-peer-urls: https://0.0.0.0:2380
listen-client-urls: https://0.0.0.0:2379
advertise-client-urls: https://192.168.10.12:2379
client-transport-security:
  # 服务端证书，在 TLS 握手过程中提供给客户端。
  cert-file: /path/to/192.168.10.12.cert
  # 服务端私钥，用来解密客户端使用服务端公钥加密发送的数据。
  key-file: /path/to/192.168.10.12.key
  # 是否要求客户端访问时提供客户端证书。
  client-cert-auth: true
  # 受信任的 CA 证书（root 证书/根证书），用来验证客户端证书。
  trusted-ca-file: /path/to/root.cert
  # 是否自动配置 TLS，开启该配置后则无需上面的其他配置。
  auto-tls: false
peer-transport-security:
  # 本节点证书，在 TLS 握手过程中提供给伙伴节点。
  cert-file: /path/to/192.168.10.12.cert
  # 本节点私钥，用来解密伙伴节点使用本节点公钥加密发送的数据。
  key-file: /path/to/192.168.10.12.key
  # 是否要求伙伴节点访问时提供其证书。
  client-cert-auth: true
  # 受信任的 CA 证书（root 证书/根证书），用来验证伙伴节点证书。
  trusted-ca-file: /path/to/root.cert
  # 是否自动配置 TLS，开启该配置后则无需上面的其他配置。
  auto-tls: false
</code></pre><p>节点 <code class="language-plaintext highlighter-rouge">192.168.10.13</code> 配置文件需要更新的配置：</p><pre><code class="language-YAML">listen-peer-urls: https://0.0.0.0:2380
listen-client-urls: https://0.0.0.0:2379
advertise-client-urls: https://192.168.10.13:2379
client-transport-security:
  # 服务端证书，在 TLS 握手过程中提供给客户端。
  cert-file: /path/to/192.168.10.13.cert
  # 服务端私钥，用来解密客户端使用服务端公钥加密发送的数据。
  key-file: /path/to/192.168.10.13.key
  # 是否要求客户端访问时提供客户端证书。
  client-cert-auth: true
  # 受信任的 CA 证书（root 证书/根证书），用来验证客户端证书。
  trusted-ca-file: /path/to/root.cert
  # 是否自动配置 TLS，开启该配置后则无需上面的其他配置。
  auto-tls: false
peer-transport-security:
  # 本节点证书，在 TLS 握手过程中提供给伙伴节点。
  cert-file: /path/to/192.168.10.13.cert
  # 本节点私钥，用来解密伙伴节点使用本节点公钥加密发送的数据。
  key-file: /path/to/192.168.10.13.key
  # 是否要求伙伴节点访问时提供其证书。
  client-cert-auth: true
  # 受信任的 CA 证书（root 证书/根证书），用来验证伙伴节点证书。
  trusted-ca-file: /path/to/root.cert
  # 是否自动配置 TLS，开启该配置后则无需上面的其他配置。
  auto-tls: false
</code></pre><p>使用 <code class="language-plaintext highlighter-rouge">etcdclt</code> 命令更新所有节点的 <code class="language-plaintext highlighter-rouge">peer-urls</code> 为 <code class="language-plaintext highlighter-rouge">https</code>（更新时保证所有节点都在线，如果有其他节点是不在线的，更新后这些节点需要作为新节点重新加入）：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>etcdctl member update e36d8869dc221ffe <span class="nt">--peer-urls</span><span class="o">=</span><span class="s2">"https://192.168.10.11:2380"</span>
<span class="go">Member e36d8869dc221ffe updated in cluster 77feb499f2ffa1c8

</span><span class="gp">$</span><span class="w"> </span>etcdctl member update 243fcfa74ec0736a <span class="nt">--peer-urls</span><span class="o">=</span><span class="s2">"https://192.168.10.12:2380"</span>
<span class="go">Member 243fcfa74ec0736a updated in cluster 77feb499f2ffa1c8

</span><span class="gp">$</span><span class="w"> </span>etcdctl member update c8ad351a3ef67e9e <span class="nt">--peer-urls</span><span class="o">=</span><span class="s2">"https://192.168.10.13:2380"</span>
<span class="go">Member c8ad351a3ef67e9e updated in cluster 77feb499f2ffa1c8
</span></pre></table></code></div></div><h2 id="重启集群">重启集群</h2><p>先依次停止所有节点服务，然后再依次启动所有节点服务（在启动第一个节点时会一直等待第二个节点的加入，这时可以直接去启动第二个节点让其加入后，第一个节点也就启动成功了，接着继续去启动第三个节点即可），启动完成后重新查看集群信息如下：</p><div class="language-console highlighter-rouge"><div class="code-header"> <span text-data=" Console "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>etcdctl <span class="nt">--key</span><span class="o">=</span><span class="s2">"/path/to/client.key"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/path/to/client.cert"</span> <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/path/to/root.cert"</span> member list <span class="nt">-w</span> table
<span class="go">+------------------+---------+-------+----------------------------+----------------------------+------------+
|        ID        | STATUS  | NAME  |        PEER ADDRS          |       CLIENT ADDRS         | IS LEARNER |
+------------------+---------+-------+----------------------------+----------------------------+------------+
| e36d8869dc221ffe | started | node1 | https://192.168.10.11:2380 | https://192.168.10.11:2379 |      false |
| 243fcfa74ec0736a | started | node2 | https://192.168.10.12:2380 | https://192.168.10.12:2379 |      false |
| c8ad351a3ef67e9e | started | node3 | https://192.168.10.13:2380 | https://192.168.10.13:2379 |      false |
+------------------+---------+-------+----------------------------+----------------------------+------------+
</span></pre></table></code></div></div><h2 id="tls-与鉴权">TLS 与鉴权</h2><p>TLS 与鉴权（Authentication）是两个不同的功能，互不影响，不能混为一谈，已知的相互间有关联的情况只有一种：当鉴权和 <code class="language-plaintext highlighter-rouge">client-transport-security</code> 都开启的情况下，一个客户端使用设置了 CN 的证书 <code class="language-plaintext highlighter-rouge">client.cert</code> 访问服务端，且未提供用户密码时，CN 的值则被当作用户名进行鉴权，但是如果访问时提供了用户密码，则使用提供的用户进行鉴权。</p><h2 id="gen_etcd_certspy-源码">gen_etcd_certs.py 源码</h2><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
</pre><td class="rouge-code"><pre><span class="s">"""
ETCD 证书生成脚本。

@requirements: 
    cryptography; python_version &gt;= '3.6'
@author: zhaowcheng@163.com
@changelog:
    2025-01-25(v0.1.0): 初版
"""</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">ipaddress</span>

<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">rsa</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.serialization</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Encoding</span><span class="p">,</span> 
                                                          <span class="n">PrivateFormat</span><span class="p">,</span>
                                                          <span class="n">NoEncryption</span><span class="p">,</span>
                                                          <span class="n">load_pem_private_key</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">cryptography.x509</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> 
                               <span class="n">NameAttribute</span><span class="p">,</span> 
                               <span class="n">SubjectAlternativeName</span><span class="p">,</span>
                               <span class="n">CertificateBuilder</span><span class="p">,</span> 
                               <span class="n">Certificate</span><span class="p">,</span>
                               <span class="n">BasicConstraints</span><span class="p">,</span>
                               <span class="n">IPAddress</span><span class="p">,</span>
                               <span class="n">load_pem_x509_certificate</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">cryptography.x509.oid</span> <span class="kn">import</span> <span class="n">NameOID</span>
<span class="kn">from</span> <span class="nn">cryptography.x509</span> <span class="kn">import</span> <span class="n">random_serial_number</span>


<span class="n">VERSION</span> <span class="o">=</span> <span class="s">'0.1.0'</span>
<span class="n">NAMEATTRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">COUNTRY_NAME</span><span class="p">,</span> <span class="s">"CN"</span><span class="p">),</span>
    <span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">STATE_OR_PROVINCE_NAME</span><span class="p">,</span> <span class="s">"CQ"</span><span class="p">),</span>
    <span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">LOCALITY_NAME</span><span class="p">,</span> <span class="s">"YB"</span><span class="p">),</span>
    <span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">ORGANIZATION_NAME</span><span class="p">,</span> <span class="s">"BC"</span><span class="p">),</span>
    <span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">ORGANIZATIONAL_UNIT_NAME</span><span class="p">,</span> <span class="s">"ZWC"</span><span class="p">)</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">printerr_and_exit</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rc</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    打印错误消息并退出。

    :param msg: 消息
    :param rc: 退出码。
    """</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'ERROR: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">save_key</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">rsa</span><span class="p">.</span><span class="n">RSAPrivateKey</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    保存私钥。

    :param key: 私钥。
    :param path: 保存路径。
    """</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">private_bytes</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">Encoding</span><span class="p">.</span><span class="n">PEM</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">PrivateFormat</span><span class="p">.</span><span class="n">TraditionalOpenSSL</span><span class="p">,</span>
            <span class="n">encryption_algorithm</span><span class="o">=</span><span class="n">NoEncryption</span><span class="p">()</span>
        <span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Saved: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">save_cert</span><span class="p">(</span><span class="n">cert</span><span class="p">:</span> <span class="n">Certificate</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    保存证书。

    :param cert: 证书。
    :param path: 保存路径。
    """</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">cert</span><span class="p">.</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">PEM</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Saved: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gen_root_cert</span><span class="p">(</span><span class="n">savedir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    生成根证书。

    :param savedir: 保存目录。
    :param days: 有效期（天）。
    """</span>
    <span class="c1"># 生成根私钥
</span>    <span class="n">root_private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="p">.</span><span class="n">generate_private_key</span><span class="p">(</span>
        <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
        <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span>
    <span class="p">)</span>

    <span class="c1"># 生成根证书的公钥
</span>    <span class="n">root_public_key</span> <span class="o">=</span> <span class="n">root_private_key</span><span class="p">.</span><span class="n">public_key</span><span class="p">()</span>

    <span class="c1"># 生成根证书的主题
</span>    <span class="n">subject</span> <span class="o">=</span> <span class="n">issuer</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="n">NAMEATTRS</span> <span class="o">+</span> <span class="p">[</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="s">"CA"</span><span class="p">)])</span>

    <span class="c1"># 生成根证书
</span>    <span class="n">root_cert</span> <span class="o">=</span> <span class="n">CertificateBuilder</span><span class="p">(</span>
    <span class="p">).</span><span class="n">subject_name</span><span class="p">(</span>
        <span class="n">subject</span>
    <span class="p">).</span><span class="n">issuer_name</span><span class="p">(</span>
        <span class="n">issuer</span>
    <span class="p">).</span><span class="n">public_key</span><span class="p">(</span>
        <span class="n">root_public_key</span>
    <span class="p">).</span><span class="n">serial_number</span><span class="p">(</span>
        <span class="n">random_serial_number</span><span class="p">()</span>
    <span class="p">).</span><span class="n">not_valid_before</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="p">).</span><span class="n">not_valid_after</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
    <span class="p">).</span><span class="n">add_extension</span><span class="p">(</span>
        <span class="n">BasicConstraints</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">path_length</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span> <span class="n">critical</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">).</span><span class="n">sign</span><span class="p">(</span><span class="n">root_private_key</span><span class="p">,</span> <span class="n">hashes</span><span class="p">.</span><span class="n">SHA256</span><span class="p">())</span>

    <span class="c1"># 保存
</span>    <span class="n">save_key</span><span class="p">(</span><span class="n">root_private_key</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="s">'root.key'</span><span class="p">))</span>
    <span class="n">save_cert</span><span class="p">(</span><span class="n">root_cert</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="s">'root.cert'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">gen_client_cert</span><span class="p">(</span>
    <span class="n">rootkey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">rootcert</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">savedir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">cn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">''</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    生成客户端证书。

    :param rootkey: 根私钥。
    :param rootcert: 根证书。
    :param savedir: 保存目录。
    :param days: 有效期（天）。
    :param cn: 用户名。
    """</span>
    <span class="c1"># 加载根私钥和证书
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rootkey</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">root_private_key</span> <span class="o">=</span> <span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rootcert</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">root_cert</span> <span class="o">=</span> <span class="n">load_pem_x509_certificate</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># 生成客户端私钥
</span>    <span class="n">client_private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="p">.</span><span class="n">generate_private_key</span><span class="p">(</span>
        <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
        <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span>
    <span class="p">)</span>

    <span class="c1"># 生成客户端证书的公钥
</span>    <span class="n">client_public_key</span> <span class="o">=</span> <span class="n">client_private_key</span><span class="p">.</span><span class="n">public_key</span><span class="p">()</span>

    <span class="c1"># 生成客户端证书的主题
</span>    <span class="k">if</span> <span class="n">cn</span><span class="p">:</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="n">NAMEATTRS</span> <span class="o">+</span> <span class="p">[</span><span class="n">NameAttribute</span><span class="p">(</span><span class="n">NameOID</span><span class="p">.</span><span class="n">COMMON_NAME</span><span class="p">,</span> <span class="n">cn</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="n">NAMEATTRS</span><span class="p">)</span>

    <span class="c1"># 生成客户端证书
</span>    <span class="n">client_cert</span> <span class="o">=</span> <span class="n">CertificateBuilder</span><span class="p">().</span><span class="n">subject_name</span><span class="p">(</span>
        <span class="n">subject</span>
    <span class="p">).</span><span class="n">issuer_name</span><span class="p">(</span>
        <span class="n">root_cert</span><span class="p">.</span><span class="n">subject</span>
    <span class="p">).</span><span class="n">public_key</span><span class="p">(</span>
        <span class="n">client_public_key</span>
    <span class="p">).</span><span class="n">serial_number</span><span class="p">(</span>
        <span class="n">random_serial_number</span><span class="p">()</span>
    <span class="p">).</span><span class="n">not_valid_before</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="p">).</span><span class="n">not_valid_after</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
    <span class="p">).</span><span class="n">sign</span><span class="p">(</span><span class="n">root_private_key</span><span class="p">,</span> <span class="n">hashes</span><span class="p">.</span><span class="n">SHA256</span><span class="p">())</span>

    <span class="c1"># 保存
</span>    <span class="n">save_key</span><span class="p">(</span><span class="n">client_private_key</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="s">'client.key'</span><span class="p">))</span>
    <span class="n">save_cert</span><span class="p">(</span><span class="n">client_cert</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="s">'client.cert'</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">gen_server_cert</span><span class="p">(</span>
    <span class="n">rootkey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">rootcert</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">savedir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    生成服务端证书。

    :param rootkey: 根私钥。
    :param rootcert: 根证书。
    :param savedir: 保存目录。
    :param days: 有效期（天）。
    :param ip: 服务端 ip。
    """</span>
    <span class="c1"># 加载根私钥和证书
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rootkey</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">root_private_key</span> <span class="o">=</span> <span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rootcert</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">root_cert</span> <span class="o">=</span> <span class="n">load_pem_x509_certificate</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># 生成服务器私钥
</span>    <span class="n">server_private_key</span> <span class="o">=</span> <span class="n">rsa</span><span class="p">.</span><span class="n">generate_private_key</span><span class="p">(</span>
        <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span>
        <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span>
    <span class="p">)</span>

    <span class="c1"># 生成服务器证书的公钥
</span>    <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">server_private_key</span><span class="p">.</span><span class="n">public_key</span><span class="p">()</span>

    <span class="c1"># 生成服务器证书的主题
</span>    <span class="n">subject</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="n">NAMEATTRS</span><span class="p">)</span>

    <span class="c1"># 生成服务器证书的扩展（包括 IP SAN）
</span>    <span class="n">san</span> <span class="o">=</span> <span class="n">SubjectAlternativeName</span><span class="p">([</span>
        <span class="n">IPAddress</span><span class="p">(</span><span class="n">ipaddress</span><span class="p">.</span><span class="n">IPv4Address</span><span class="p">(</span><span class="s">'127.0.0.1'</span><span class="p">)),</span>
        <span class="n">IPAddress</span><span class="p">(</span><span class="n">ipaddress</span><span class="p">.</span><span class="n">IPv4Address</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
    <span class="p">])</span>

    <span class="c1"># 生成服务器证书
</span>    <span class="n">server_cert</span> <span class="o">=</span> <span class="n">CertificateBuilder</span><span class="p">().</span><span class="n">subject_name</span><span class="p">(</span>
        <span class="n">subject</span>
    <span class="p">).</span><span class="n">issuer_name</span><span class="p">(</span>
        <span class="n">root_cert</span><span class="p">.</span><span class="n">subject</span>
    <span class="p">).</span><span class="n">public_key</span><span class="p">(</span>
        <span class="n">server_public_key</span>
    <span class="p">).</span><span class="n">serial_number</span><span class="p">(</span>
        <span class="n">random_serial_number</span><span class="p">()</span>
    <span class="p">).</span><span class="n">not_valid_before</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="p">).</span><span class="n">not_valid_after</span><span class="p">(</span>
        <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
    <span class="p">).</span><span class="n">add_extension</span><span class="p">(</span>
        <span class="n">san</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">).</span><span class="n">sign</span><span class="p">(</span><span class="n">root_private_key</span><span class="p">,</span> <span class="n">hashes</span><span class="p">.</span><span class="n">SHA256</span><span class="p">())</span>

    <span class="c1"># 保存
</span>    <span class="n">save_key</span><span class="p">(</span><span class="n">server_private_key</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">.key'</span><span class="p">))</span>
    <span class="n">save_cert</span><span class="p">(</span><span class="n">server_cert</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">.cert'</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">create_parser</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
    <span class="s">"""
    创建命令行参数解析器。
    """</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-c'</span><span class="p">,</span> <span class="s">'--command'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">'gen_root_cert'</span><span class="p">,</span> <span class="s">'gen_client_cert'</span><span class="p">,</span> <span class="s">'gen_server_cert'</span><span class="p">])</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-s'</span><span class="p">,</span> <span class="s">'--savedir'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'.'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Save directory. [default: .]'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-d'</span><span class="p">,</span> <span class="s">'--days'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>  <span class="n">default</span><span class="o">=</span><span class="mi">3650</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s">'Certificate validity period. [default: 3650]'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-n'</span><span class="p">,</span> <span class="s">'--cn'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'Common name(only used for gen_client_cert).'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-k'</span><span class="p">,</span> <span class="s">'--root-key'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="p">(</span><span class="s">'gen_client_cert'</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span> <span class="ow">or</span> <span class="s">'gen_server_cert'</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">'Root private key.'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-t'</span><span class="p">,</span> <span class="s">'--root-cert'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="p">(</span><span class="s">'gen_client_cert'</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span> <span class="ow">or</span> <span class="s">'gen_server_cert'</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">'Root certificate.'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-i'</span><span class="p">,</span> <span class="s">'--ip'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="p">(</span><span class="s">'gen_server_cert'</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">),</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">'Server IP.'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-v'</span><span class="p">,</span> <span class="s">'--version'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">'version'</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">VERSION</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    入口函数。
    """</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">create_parser</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">savedir</span><span class="p">):</span>
        <span class="n">printerr_and_exit</span><span class="p">(</span><span class="sa">f</span><span class="s">'Savedir `</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">savedir</span><span class="si">}</span><span class="s">` does not exist.'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="s">'gen_root_cert'</span><span class="p">:</span>
        <span class="n">gen_root_cert</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">savedir</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">days</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="s">'gen_client_cert'</span><span class="p">:</span>
        <span class="n">gen_client_cert</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">root_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">root_cert</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">savedir</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">days</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">cn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="s">'gen_server_cert'</span><span class="p">:</span>
        <span class="n">gen_server_cert</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">root_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">root_cert</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">savedir</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">days</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="参考资料">参考资料</h2><ul><li>[Transport security model] : https://etcd.io/docs/v3.5/op-guide/security/</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/etcd/'>ETCD</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/etcd/" class="post-tag no-text-decoration" >etcd</a> <a href="/tags/network/" class="post-tag no-text-decoration" >network</a> <a href="/tags/ssl/" class="post-tag no-text-decoration" >ssl</a> <a href="/tags/tls/" class="post-tag no-text-decoration" >tls</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>最近更新</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/postgresql-version-policy/">PostgreSQL 版本策略（versioning policy)</a><li><a href="/posts/postgresql-locale/">PostgreSQL 区域设置（locale）</a><li><a href="/posts/a-packaging-method-with-its-own-deps/">一种让 Linux 上的 C/C++ 程序自带依赖库的打包方式</a><li><a href="/posts/etcd-tls/">ETCD 配置 TLS</a><li><a href="/posts/ssl-notes/">SSL/TLS 笔记</a></ul></div><div id="access-tags"> <span>热门标签</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/postgresql/">postgresql</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/ssl/">ssl</a> <a class="post-tag" href="/tags/tls/">tls</a> <a class="post-tag" href="/tags/automation-testing/">automation-testing</a> <a class="post-tag" href="/tags/bridge/">bridge</a> <a class="post-tag" href="/tags/character-set/">character-set</a> <a class="post-tag" href="/tags/codeset/">codeset</a> <a class="post-tag" href="/tags/cpu/">cpu</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">文章内容</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ssl-notes/"><div class="card-body"> <span class="timeago small" >01-25<i class="unloaded">2025-01-25T19:41:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SSL/TLS 笔记</h3><div class="text-muted small"><p> 密码学基础 对称加密（又称单钥加密、私钥加密、共享密钥加密）：加密和解密使用同一个密钥，常见算法有 AES 和 DES 等。 非对称加密（又称双钥加密、公钥加密）：有一对密钥，私钥和公钥，公钥加密的数据，只能用对应的私钥来解密，反之亦然，常见算法有 RSA, DSA, DH, ECDSA 等。 数字签名（Digital Signatu...</p></div></div></a></div><div class="card"> <a href="/posts/kvm-bridge-by-iptables/"><div class="card-body"> <span class="timeago small" >02-21<i class="unloaded">2025-02-21T20:59:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>使用 iptables 为 KVM 虚拟机实现桥接网络</h3><div class="text-muted small"><p> 适用场景 我把一台笔记本电脑安装了 Linux，准备用来作为 KVM 虚拟机服务器，这台笔记本只有无线网卡，当我想把这个无线网卡桥接到虚拟机时，始终无法成功，网上也查了很多资料，始终没有解决。 最终决定放弃桥接网络，改用 NAT 端口转发来实现外部访问虚拟机，然后参考了 Libvirt 文档 通过 iptables 配置了端口转发，用了一段时间后发现把这个配置稍加改造就可以达到和桥接网络...</p></div></div></a></div><div class="card"> <a href="/posts/patroni-configuration/"><div class="card-body"> <span class="timeago small" >03-27<i class="unloaded">2025-03-27T18:58:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Patroni 配置说明</h3><div class="text-muted small"><p> 1 配置类型 全局配置（Global Configuration） 作用范围：所有节点。 修改方式：初始化（bootstrap）前，修改配置文件中的 bootstrap.dcs 部分；初始化后，通过 patronictl edit-config 命令或 REST 接口 /config 修改...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ssl-notes/" class="btn btn-outline-primary" prompt="上一篇"><p>SSL/TLS 笔记</p></a> <a href="/posts/kvm-bridge-by-iptables/" class="btn btn-outline-primary" prompt="下一篇"><p>使用 iptables 为 KVM 虚拟机实现桥接网络</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://zhaowcheng.com">zhaowcheng</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span> <a href="https://beian.miit.gov.cn" target="_blank" rel="noopener">蜀ICP备2021030991号-1</a></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">热门标签</h4><a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/postgresql/">postgresql</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/ssl/">ssl</a> <a class="post-tag" href="/tags/tls/">tls</a> <a class="post-tag" href="/tags/automation-testing/">automation testing</a> <a class="post-tag" href="/tags/bridge/">bridge</a> <a class="post-tag" href="/tags/character-set/">character set</a> <a class="post-tag" href="/tags/codeset/">codeset</a> <a class="post-tag" href="/tags/cpu/">cpu</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-PVZNL9JKFB"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-PVZNL9JKFB'); }); </script>
